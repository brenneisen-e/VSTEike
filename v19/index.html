<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertriebssteuerungs-Cockpit</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- ========================================
     LANDING PAGE
     ======================================== -->
<div id="landingPage" class="landing-page">
    <!-- Loading Animation -->
    <div id="loadingAnimation" class="loading-container">
        <h1 class="loading-title">Financial Service Sales Excellence Platform</h1>
        <div class="dashboard-icon-animated">
            <div class="icon-bar bar-1"></div>
            <div class="icon-bar bar-2"></div>
            <div class="icon-bar bar-3"></div>
            <div class="icon-bar bar-4"></div>
        </div>
        <p class="loading-text">Wird geladen...</p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="loading-percent" id="loadingPercent">0%</p>
    </div>

    <!-- Welcome Chat -->
    <div id="welcomeChat" class="welcome-chat" style="display: none;">
        <div class="welcome-chat-header">
            <div class="chat-header-info">
                <span class="chat-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zM7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5zM16 17H8v-2h8v2zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13z"/></svg></span>
                <div>
                    <div class="chat-title">Dashboard Assistent</div>
                    <div class="chat-subtitle">Claude AI</div>
                </div>
            </div>
        </div>

        <div class="welcome-chat-body">
            <div class="welcome-message">
                <div class="chat-avatar"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zM7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5zM16 17H8v-2h8v2zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13z"/></svg></div>
                <div class="chat-bubble">
                    <p><strong>Hallo!</strong></p>
                    <p class="typewriter-text">Ich bin dein KI-Assistent f√ºr das Vertriebssteuerungs-Cockpit.</p>
                    <p class="typewriter-text-2">Was m√∂chtest du tun?</p>
                </div>
            </div>

            <!-- ‚ú® v18.3: Input direkt nach Willkommensnachricht -->
            <div class="landing-chat-section">
                <div class="landing-chat-input-container">
                    <textarea
                        class="landing-chat-input"
                        id="landingChatInput"
                        placeholder="Frag mich etwas √ºber das Dashboard..."
                        rows="1"
                    ></textarea>
                    <button class="landing-chat-send" id="landingChatSend">
                        <span>‚û§</span>
                    </button>
                </div>

                <!-- Schnellauswahl-Buttons -->
                <div class="landing-sample-questions" id="landingSampleQuestions">
                    <button class="sample-question-btn" onclick="askLandingSampleQuestion('Was kann dieses Tool?')">
                        Tool-Funktionen
                    </button>
                    <button class="sample-question-btn" onclick="askLandingSampleQuestion('Welche Module gibt es?')">
                        Alle Module
                    </button>
                    <button class="sample-question-btn" onclick="askLandingSampleQuestion('Was zeigt die Banken-Ansicht?')">
                        Banken-Ansicht
                    </button>
                    <button class="sample-question-btn" onclick="askLandingSampleQuestion('Wie funktioniert die KI-Analyse?')">
                        KI-Analyse
                    </button>
                </div>

                <div class="landing-chat-messages" id="landingChatMessages">
                    <!-- Messages werden hier eingef√ºgt -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="welcome-actions">
                <button class="action-button primary" onclick="openDashboard()">
                    <span class="action-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></span>
                    <div class="action-content">
                        <div class="action-title">Zur Gesamt√ºbersicht</div>
                        <div class="action-description">Dashboard mit allen KPIs √∂ffnen</div>
                    </div>
                </button>

                <button class="action-button" onclick="openGenerator()">
                    <span class="action-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></span>
                    <div class="action-content">
                        <div class="action-title">Test-Daten generieren</div>
                        <div class="action-description">CSV-Generator √∂ffnen</div>
                    </div>
                </button>
            </div>

            <!-- Quick Upload -->
            <div class="quick-upload">
                <label class="upload-box" for="quickCsvUpload">
                    <input type="file" id="quickCsvUpload" accept=".csv" style="display: none;">
                    <span class="upload-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg></span>
                    <span class="upload-text">Oder ziehe eine CSV-Datei hierher</span>
                </label>
                <div id="quickUploadStatus" class="upload-status"></div>
            </div>

            <!-- API Token Eingabe f√ºr Claude -->
            <div class="api-token-section">
                <div class="api-token-header">
                    <span class="api-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg></span>
                    <span class="api-title">Claude API-Key (Optional)</span>
                </div>
                <div class="api-token-input-wrapper">
                    <input
                        type="password"
                        id="apiTokenInput"
                        class="api-token-input"
                        placeholder="sk-ant-..."
                    />
                    <button id="apiTokenToggle" class="api-token-toggle" title="Anzeigen/Verbergen">show</button>
                    <button id="apiTokenSave" class="api-token-save">Speichern</button>
                </div>
                <div id="apiTokenStatus" class="api-token-status"></div>
                <div class="api-token-hint">
                    F√ºr echte KI-Analysen mit Claude Sonnet 4.5. Im Mock-Modus sind vorgefertigte Antworten aktiv.
                    <a href="https://console.anthropic.com/settings/keys" target="_blank">API-Key erhalten</a>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- ========================================
         MAIN APPLICATION (v02 Dashboard)
         ======================================== -->
    <div id="mainApp" style="display: none;">
    <!-- Upload Section -->
    <div class="upload-section">
        <label class="upload-label" for="csvUpload">
            üìä CSV-Datei hochladen
            <input type="file" id="csvUpload" accept=".csv">
        </label>
        <span id="fileStatus" style="margin-left: 1rem; color: #0369a1; font-weight: 600;"></span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="back-button" onclick="backToLanding()">‚Üê Zur√ºck</button>
                <div class="view-mode-toggle">
                    <button class="active" data-mode="dashboard">üìä Dashboard</button>
                    <button data-mode="table">üìã Tabelle</button>
                </div>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Jahr:</span>
                    <select id="yearFilter">
                        <option value="2025">2025 YTD</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <!-- NEU: Agentur Filter -->
                <div class="filter-group">
                    <span class="filter-label">Agentur:</span>
                    <div class="dropdown">
                        <button class="dropdown-button" id="agenturFilterButton">
                            <span>Alle Agenturen</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="agenturFilterMenu">
                            <div class="dropdown-item" data-value="alle">
                                <span>Alle Agenturen</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Ende Agentur Filter -->
                <div class="filter-group">
                    <span class="filter-label">Vertriebssilo:</span>
                    <select id="siloFilter">
                        <option value="alle">Alle Vermittler</option>
                        <option value="Ausschlie√ülichkeit">Ausschlie√ülichkeit</option>
                        <option value="Makler">Makler</option>
                        <option value="Direktvertrieb">Direktvertrieb</option>
                        <option value="Banken">Banken</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Segment:</span>
                    <div class="dropdown">
                        <button class="dropdown-button" id="segmentButton">
                            <span>Alle Segmente</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="segmentMenu">
                            <div class="dropdown-item" data-value="alle">
                                <div class="checkbox checked"></div>
                                <span>Alle Segmente</span>
                            </div>
                            <div class="dropdown-separator"></div>
                            <div class="dropdown-item" data-value="Leben">
                                <div class="checkbox"></div>
                                <span>Leben</span>
                            </div>
                            <div class="dropdown-item" data-value="Kranken">
                                <div class="checkbox"></div>
                                <span>Kranken</span>
                            </div>
                            <div class="dropdown-item" data-value="Schaden">
                                <div class="checkbox"></div>
                                <span>Schaden</span>
                            </div>
                            <div class="dropdown-item" data-value="Kfz">
                                <div class="checkbox"></div>
                                <span>Kfz</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group" id="productFilterGroup" style="display: none;">
                    <span class="filter-label">Produkt:</span>
                    <div class="dropdown">
                        <button class="dropdown-button" id="productButton">
                            <span>Alle Produkte</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="productMenu"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard View -->
    <main class="main" id="dashboardView">
        <div class="kpi-grid" id="kpiGrid"></div>
        <div class="map-sidebar">
            <div id="map" class="map-container"></div>
            <div class="map-info">
                <h3>Ausgew√§hlte Landkreise</h3>
                <div class="selected-states" id="selectedStates">
                    <span class="empty-state">‚Äî keine ‚Äî</span>
                </div>
                <button class="clear-button" id="clearStates" disabled>Alle abw√§hlen</button>
            </div>

            <!-- KI-Antwort Display unter der Karte -->
            <div class="ai-response-panel" id="aiResponsePanel" style="display: none;">
                <div class="ai-response-header">
                    <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zM7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5zM16 17H8v-2h8v2zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13z"/></svg>KI-Analyse</h3>
                    <button class="ai-response-close" id="aiResponseClose">‚úï</button>
                </div>
                <div class="ai-response-content" id="aiResponseContent">
                    <!-- KI-Antworten werden hier formatiert angezeigt -->
                </div>
            </div>
        </div>
    </main>

    <!-- Table View -->
    <div class="table-view-container" id="tableView">
        <div style="max-width: 1920px; margin: 0 auto; padding: 1.25rem;">
            <div class="table-controls">
                <div class="table-view-toggle">
                    <button class="active" data-table-view="bundeslaender">üó∫Ô∏è Bundesl√§nder</button>
                    <button data-table-view="landkreise">üèòÔ∏è Landkreise</button>
                    <button data-table-view="agentur">üë§ Agenturen</button>
                </div>
                <!-- NEU: Agentur-Mehrfachauswahl Panel -->
                <div class="filter-group" id="agenturMultiSelector" style="display: none;">
                    <button class="filter-button" id="agenturMultiButton">
                        <span>Agenturen ausw√§hlen</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-menu agentur-dropdown" id="agenturMultiMenu" style="max-height: 400px; overflow-y: auto;">
                        <div class="dropdown-item" data-value="alle">
                            <span class="checkbox"></span>
                            <span>Alle Agenturen</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div id="agenturCheckboxList">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>
                </div>
                <div class="selected-agenturen" id="selectedAgenturen" style="display: none;"></div>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div class="fullscreen-modal" id="fullscreenModal">
        <div class="fullscreen-kpi">
            <div class="fullscreen-header">
                <h2 class="fullscreen-title" id="fullscreenTitle">KPI Title</h2>
                <button class="fullscreen-close" onclick="closeFullscreen()">‚úï Schlie√üen</button>
            </div>
            <div class="fullscreen-chart">
                <canvas id="fullscreenChart"></canvas>
            </div>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div class="chat-widget" id="chatWidget" style="display: none;">
        <div class="chat-header">
            <div class="chat-header-info">
                <span class="chat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zM7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5zM16 17H8v-2h8v2zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13z"/></svg></span>
                <div>
                    <div class="chat-title">Dashboard Assistent</div>
                    <div class="chat-subtitle">Claude AI</div>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-minimize" id="chatMinimize">‚àí</button>
                <button class="chat-close" id="chatClose">‚úï</button>
            </div>
        </div>
        
        <div class="chat-body" id="chatBody">
            <div class="chat-welcome">
                <h3>Willkommen!</h3>
                <p>Ich kann dir bei der Analyse deiner Dashboard-Daten helfen.</p>

                <!-- Probefragen als anklickbare Buttons -->
                <div class="sample-questions">
                    <button class="sample-question-btn" onclick="askSampleQuestion('Zeige mir die Top 5 Vermittler nach Neugesch√§ft')">
                        Top 5 Vermittler
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Welches Bundesland hat die beste Performance?')">
                        Beste Bundesl√§nder
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Wie entwickelt sich der NPS Score?')">
                        NPS Entwicklung
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Vergleiche Makler vs. Ausschlie√ülichkeit')">
                        Silo-Vergleich
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Zeige mir die Stornoquoten nach Segment')">
                        Stornoquoten
                    </button>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="Stelle eine Frage zu deinen Daten..."
                rows="1"
            ></textarea>
            <button class="chat-send" id="chatSend">
                <span>‚ñ∂</span>
            </button>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button class="chat-toggle" id="chatToggle" style="display: none;">
        <span class="chat-badge" id="chatBadge">1</span>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
    </button>

    <!-- Info Tooltip -->
    <div id="info-tooltip" style="
        position: absolute;
        display: none;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        pointer-events: none;
        z-index: 1000;
        font-size: 13px;
        border: 1px solid #e2e8f0;
    "></div>
    </div>

    <!-- Version Display - Always visible on all pages -->
    <div class="version-display">v19</div>

    <!-- JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/data.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/tables.js"></script>
    <script src="js/map-counties.js"></script>
    <script src="js/main.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/landing.js"></script>
</body>
</html>