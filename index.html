<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertriebssteuerungs-Cockpit</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- ========================================
     LANDING PAGE
     ======================================== -->
<div id="landingPage" class="landing-page">

    <!-- Hidden File Inputs für Profilbild-Upload -->
    <input type="file" id="userProfileUpload" accept="image/*" style="display: none;" onchange="handleUserProfileUpload(event)">
    <input type="file" id="userProfileUploadDropdown" accept="image/*" style="display: none;" onchange="handleUserProfileUploadDropdown(event)">

    <!-- User Profile Switcher (oben rechts) -->
    <div class="user-profile-switcher" id="userProfileSwitcher">
        <div class="profile-display">
            <div class="profile-avatar" onclick="triggerUserProfileUpload(event)" title="Klicken zum Ändern des Profilbilds">
                <img src="assets/images/default-profile.svg" alt="Profilbild" id="profileAvatarImg">
                <div class="avatar-upload-overlay">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                        <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </div>
            </div>
            <div class="profile-info-clickable" onclick="toggleProfileDropdown()">
                <div class="profile-info">
                    <span class="profile-name" id="profileName">Eike Brenneisen</span>
                    <span class="profile-role" id="profileRole">Vertriebssteuerung</span>
                </div>
                <svg class="profile-dropdown-arrow" id="profileArrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-option" data-mode="vertrieb">
                <div class="option-avatar clickable" onclick="triggerUserProfileUploadFor('vertrieb', event)" title="Bild ändern">
                    <img src="assets/images/default-profile.svg" alt="Eike" id="optionAvatarVertrieb">
                </div>
                <div class="option-info" onclick="switchUserMode('vertrieb')">
                    <span class="option-name">Eike Brenneisen</span>
                    <span class="option-role">Vertriebssteuerung</span>
                </div>
                <svg class="option-check" id="checkVertrieb" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="18" height="18">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="profile-option" data-mode="pva">
                <div class="option-avatar clickable" onclick="triggerUserProfileUploadFor('pva', event)" title="Bild ändern">
                    <img src="assets/images/default-profile.svg" alt="Anja" id="optionAvatarPva">
                </div>
                <div class="option-info" onclick="switchUserMode('pva')">
                    <span class="option-name">Anja Schneider</span>
                    <span class="option-role">Sales Operations</span>
                </div>
                <svg class="option-check" id="checkPva" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="18" height="18" style="display: none;">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
        </div>
    </div>

    <!-- Loading Animation -->
    <div id="loadingAnimation" class="loading-container">
        <div class="dashboard-icon-animated">
            <div class="icon-bar bar-1"></div>
            <div class="icon-bar bar-2"></div>
            <div class="icon-bar bar-3"></div>
            <div class="icon-bar bar-4"></div>
        </div>
        <p class="loading-text">Wird geladen...</p>
    </div>

    <!-- Welcome Chat -->
    <div id="welcomeChat" class="welcome-chat" style="display: none;">
        <div class="welcome-chat-header">
            <div class="chat-header-info">
                <div class="chat-icon-deloitte">
                    <span class="deloitte-d">D</span>
                </div>
                <div>
                    <div class="chat-title">Sales Steering - Agent</div>
                    <div class="chat-subtitle">Willkommen zurück!</div>
                </div>
            </div>
        </div>

        <div class="welcome-chat-body">
            <div class="welcome-message">
                <div class="chat-avatar-deloitte">
                    <span class="deloitte-d">D</span>
                </div>
                <div class="chat-bubble">
                    <p><strong>Willkommen zurück Eike, was kann ich für dich tun?</strong></p>
                </div>
            </div>

            <!-- ✨ v18.3: Input direkt nach Willkommensnachricht -->
            <div class="landing-chat-section">
                <div class="landing-chat-input-wrapper">
                    <div class="landing-chat-input-container">
                        <textarea
                            class="landing-chat-input"
                            id="landingChatInput"
                            placeholder="Frag mich etwas..."
                            rows="1"
                        ></textarea>
                        <button class="landing-chat-send" id="landingChatSend">
                            <span>➤</span>
                        </button>
                    </div>
                    <!-- Autocomplete Suggestions direkt unter Input -->
                    <div class="autocomplete-suggestions" id="autocompleteSuggestions" style="display: none;"></div>
                </div>

                <!-- Navigation Boxen -->
                <div class="navigation-boxes">
                    <button class="nav-box" onclick="openAgenturView()">
                        <svg class="nav-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span>Agenturansicht</span>
                    </button>
                    <button class="nav-box" onclick="openDashboard()">
                        <svg class="nav-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                            <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                            <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                            <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                        </svg>
                        <span>Gesamtübersicht</span>
                    </button>
                    <button class="nav-box" onclick="openPotentialAnalyse()">
                        <svg class="nav-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"></path>
                            <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                            <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                            <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                        <span>Potentialanalyse</span>
                    </button>
                </div>

                <div class="landing-chat-messages" id="landingChatMessages">
                    <!-- Messages werden hier eingefügt -->
                </div>
            </div>

            <!-- Settings Box (ausklappbar) -->
            <div class="settings-collapsible">
                <button class="settings-toggle" onclick="toggleSettings()">
                    <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path>
                    </svg>
                    <span>Settings</span>
                    <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="settings-content" id="settingsContent">
                    <!-- Test-Daten generieren -->
                    <div class="settings-item" onclick="openGenerator()">
                        <svg class="settings-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <span>Test-Daten generieren</span>
                    </div>

                    <!-- CSV Upload -->
                    <div class="settings-item">
                        <label for="quickCsvUpload" class="settings-upload-label">
                            <svg class="settings-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span>CSV Upload</span>
                            <input type="file" id="quickCsvUpload" accept=".csv" style="display: none;">
                        </label>
                    </div>
                    <div id="quickUploadStatus" class="upload-status"></div>

                    <!-- OpenAI API Key -->
                    <div class="settings-api-section">
                        <div class="settings-item-header">
                            <svg class="settings-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                            </svg>
                            <span>OpenAI API-Key</span>
                        </div>
                        <div class="api-token-input-wrapper">
                            <input
                                type="password"
                                id="apiTokenInput"
                                class="api-token-input"
                                placeholder="sk-proj-..."
                            />
                            <button id="apiTokenToggle" class="api-token-toggle" title="Anzeigen/Verbergen">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            <button id="apiTokenSave" class="api-token-save">Speichern</button>
                        </div>
                        <div id="apiTokenStatus" class="api-token-status"></div>
                    </div>

                    <!-- Mock-Modus Toggle -->
                    <div class="settings-item mock-toggle">
                        <svg class="settings-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0110 0v4"></path>
                        </svg>
                        <span>Mock-Modus</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="mockModeToggle" checked>
                            <label for="mockModeToggle"></label>
                        </div>
                    </div>

                    <!-- Upload-Modus Toggle -->
                    <div class="settings-item mock-toggle">
                        <svg class="settings-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span>Upload-Modus</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="uploadModeToggle" onchange="toggleUploadMode()">
                            <label for="uploadModeToggle"></label>
                        </div>
                    </div>
                    <div class="upload-mode-hint" id="uploadModeHint" style="display: none;">
                        Klicke auf das Logo oder Profilbild um eigene Bilder hochzuladen.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- ========================================
         AGENTUR OVERVIEW PAGE (Fachkonzept-konform)
         ======================================== -->
    <div id="agenturOverview" style="display: none;">
        <div class="agentur-page-new">
            <!-- Header mit Back Button und Agentur-Info -->
            <div class="agentur-header-new">
                <div class="agentur-header-left">
                    <button class="back-button" onclick="backFromAgentur()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg> Zurück</button>
                    <div class="agentur-header-info">
                        <div class="agentur-photo-small" id="agenturPhotoSmall" onclick="triggerAgenturPhotoUpload()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="agentur-photo-placeholder-small">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <img id="agenturPhotoImgSmall" class="agentur-photo-img-small" style="display: none;" alt="Foto">
                        </div>
                        <div class="agentur-header-text">
                            <h1 class="agentur-page-title" id="agenturPageTitle">Agentur-Übersicht</h1>
                            <div class="agentur-subtitle">
                                <span id="agenturIdHeader">-</span> | <span id="agenturStatusHeader">Aktiv</span>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="file" id="agenturPhotoInput" accept="image/*" style="display: none;" onchange="handleAgenturPhotoUpload(event)">
            </div>

            <!-- Ebene 1: Cockpit-Übersicht (Big Numbers) -->
            <div class="cockpit-kpis">
                <div class="cockpit-kpi-card">
                    <div class="cockpit-kpi-icon bestand">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"></path>
                        </svg>
                    </div>
                    <div class="cockpit-kpi-content">
                        <div class="cockpit-kpi-value" id="cockpitBestand">€0</div>
                        <div class="cockpit-kpi-label">Gesamtbestand</div>
                        <div class="cockpit-kpi-trend positive" id="cockpitBestandTrend">+0%</div>
                    </div>
                </div>
                <div class="cockpit-kpi-card">
                    <div class="cockpit-kpi-icon neugeschaeft">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <polyline points="19 12 12 19 5 12"></polyline>
                        </svg>
                    </div>
                    <div class="cockpit-kpi-content">
                        <div class="cockpit-kpi-value" id="cockpitNeugeschaeft">€0</div>
                        <div class="cockpit-kpi-label">Neugeschäft YTD</div>
                        <div class="cockpit-kpi-trend positive" id="cockpitNeugeschaeftTrend">+0%</div>
                    </div>
                </div>
                <div class="cockpit-kpi-card">
                    <div class="cockpit-kpi-icon storno">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <div class="cockpit-kpi-content">
                        <div class="cockpit-kpi-value" id="cockpitStorno">0%</div>
                        <div class="cockpit-kpi-label">Storno-Quote</div>
                        <div class="cockpit-kpi-trend negative" id="cockpitStornoTrend">+0%</div>
                    </div>
                </div>
                <div class="cockpit-kpi-card">
                    <div class="cockpit-kpi-icon ziel">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="6"></circle>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>
                    </div>
                    <div class="cockpit-kpi-content">
                        <div class="cockpit-kpi-value" id="cockpitZiel">0%</div>
                        <div class="cockpit-kpi-label">Zielerfüllung</div>
                        <div class="cockpit-kpi-gauge" id="cockpitZielGauge">
                            <div class="gauge-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hauptinhalt mit Tabs -->
            <div class="agentur-main-content">
                <!-- Tab Navigation -->
                <div class="agentur-tabs">
                    <button class="agentur-tab active" onclick="showAgenturTab('stammdaten')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Stammdaten
                    </button>
                    <button class="agentur-tab" onclick="showAgenturTab('neugeschaeft')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="20" x2="12" y2="10"></line>
                            <line x1="18" y1="20" x2="18" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="16"></line>
                        </svg>
                        Neugeschäft
                    </button>
                    <button class="agentur-tab" onclick="showAgenturTab('bestand')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"></path>
                        </svg>
                        Bestand
                    </button>
                    <button class="agentur-tab" onclick="showAgenturTab('storno')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        Storno
                    </button>
                    <button class="agentur-tab" onclick="showAgenturTab('provision')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path>
                        </svg>
                        Vergütung
                    </button>
                    <button class="agentur-tab" onclick="showAgenturTab('qualitaet')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        Qualität
                    </button>
                </div>

                <!-- Tab Content: Stammdaten -->
                <div class="agentur-tab-content active" id="tab-stammdaten">
                    <div class="stammdaten-sections">
                        <!-- Basis-Stammdaten -->
                        <div class="stammdaten-section">
                            <h3>Basis-Stammdaten</h3>
                            <div class="stammdaten-grid-new">
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Agenturnummer</div>
                                    <div class="stammdaten-value" id="agenturId">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Name / Firma</div>
                                    <div class="stammdaten-value" id="agenturName">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Adresse</div>
                                    <div class="stammdaten-value" id="agenturAdresse">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Telefon</div>
                                    <div class="stammdaten-value" id="agenturTelefon">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">E-Mail</div>
                                    <div class="stammdaten-value" id="agenturEmail">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Agenturtyp</div>
                                    <div class="stammdaten-value" id="agenturTyp">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Status</div>
                                    <div class="stammdaten-value status-badge active" id="agenturStatus">Aktiv</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Vertragsbeginn</div>
                                    <div class="stammdaten-value" id="agenturEintritt">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Organisatorische Einordnung -->
                        <div class="stammdaten-section">
                            <h3>Organisatorische Einordnung</h3>
                            <div class="stammdaten-grid-new">
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Vertriebshierarchie</div>
                                    <div class="stammdaten-value" id="agenturHierarchie">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Vorgesetzter / Betreuer</div>
                                    <div class="stammdaten-value" id="agenturVorgesetzter">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Region / Gebiet</div>
                                    <div class="stammdaten-value" id="agenturRegion">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Vertriebskanal</div>
                                    <div class="stammdaten-value" id="agenturSilo">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Cluster / Segment</div>
                                    <div class="stammdaten-value" id="agenturStufe">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Qualifikation & Zulassung -->
                        <div class="stammdaten-section">
                            <h3>Qualifikation & Zulassung</h3>
                            <div class="stammdaten-grid-new">
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">IHK-Registernummer</div>
                                    <div class="stammdaten-value" id="agenturIHK">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Vermittlerstatus</div>
                                    <div class="stammdaten-value" id="agenturVermittlerStatus">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Produktfreigaben</div>
                                    <div class="stammdaten-value" id="agenturProduktfreigaben">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Weiterbildungsstatus (IDD)</div>
                                    <div class="stammdaten-value status-badge" id="agenturWeiterbildung">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Vertragliche Rahmendaten -->
                        <div class="stammdaten-section">
                            <h3>Vertragliche Rahmendaten</h3>
                            <div class="stammdaten-grid-new">
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Provisionsmodell</div>
                                    <div class="stammdaten-value" id="agenturProvModell">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Bonusvereinbarung</div>
                                    <div class="stammdaten-value" id="agenturBonus">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Stornohaftungszeit</div>
                                    <div class="stammdaten-value" id="agenturStornohaftung">-</div>
                                </div>
                                <div class="stammdaten-item-new">
                                    <div class="stammdaten-label">Exklusivitätsgrad</div>
                                    <div class="stammdaten-value" id="agenturExklusiv">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Neugeschäft -->
                <div class="agentur-tab-content" id="tab-neugeschaeft">
                    <div class="kpi-detail-grid">
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Anträge</div>
                            <div class="kpi-detail-value" id="ngAntraege">0</div>
                            <div class="kpi-detail-sub">Stück eingereicht</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Policiertes Neugeschäft</div>
                            <div class="kpi-detail-value" id="ngPoliciert">€0</div>
                            <div class="kpi-detail-sub">Tatsächlich policiert</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Jahresbeitrag (APE)</div>
                            <div class="kpi-detail-value" id="ngAPE">€0</div>
                            <div class="kpi-detail-sub">Annual Premium Equivalent</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Abschlussquote</div>
                            <div class="kpi-detail-value" id="ngAbschlussquote">0%</div>
                            <div class="kpi-detail-sub">Policiert / Eingereicht</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Ø Beitrag</div>
                            <div class="kpi-detail-value" id="ngDurchschnitt">€0</div>
                            <div class="kpi-detail-sub">Pro Vertrag</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Cross-Selling-Quote</div>
                            <div class="kpi-detail-value" id="ngCrossSelling">0%</div>
                            <div class="kpi-detail-sub">Kunden mit >1 Vertrag</div>
                        </div>
                    </div>
                    <div class="sparten-chart">
                        <h3>Spartenverteilung Neugeschäft</h3>
                        <div class="sparten-bars" id="spartenNeugeschaeft"></div>
                    </div>
                </div>

                <!-- Tab Content: Bestand -->
                <div class="agentur-tab-content" id="tab-bestand">
                    <div class="kpi-detail-grid">
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Bestandsbeitrag (GWP)</div>
                            <div class="kpi-detail-value" id="bestandGWP">€0</div>
                            <div class="kpi-detail-sub">Gesamter Bestand</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Vertragsanzahl</div>
                            <div class="kpi-detail-value" id="bestandVertraege">0</div>
                            <div class="kpi-detail-sub">Aktive Verträge</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Bestandswachstum</div>
                            <div class="kpi-detail-value" id="bestandWachstum">0%</div>
                            <div class="kpi-detail-sub">vs. Vorjahr</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Kundenzahl</div>
                            <div class="kpi-detail-value" id="bestandKunden">0</div>
                            <div class="kpi-detail-sub">Aktive Kunden</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Verträge pro Kunde</div>
                            <div class="kpi-detail-value" id="bestandDichte">0</div>
                            <div class="kpi-detail-sub">Vertragsdichte</div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Storno -->
                <div class="agentur-tab-content" id="tab-storno">
                    <div class="kpi-detail-grid">
                        <div class="kpi-detail-card warning">
                            <div class="kpi-detail-header">Frühstorno-Quote</div>
                            <div class="kpi-detail-value" id="stornoFrueh">0%</div>
                            <div class="kpi-detail-sub">&lt; 12 Monate</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Spätstorno-Quote</div>
                            <div class="kpi-detail-value" id="stornoSpaet">0%</div>
                            <div class="kpi-detail-sub">&gt; 12 Monate</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Netto-Bestandsentwicklung</div>
                            <div class="kpi-detail-value" id="stornoNetto">€0</div>
                            <div class="kpi-detail-sub">Neugeschäft - Storno</div>
                        </div>
                    </div>
                    <div class="storno-reasons">
                        <h3>Storno-Gründe</h3>
                        <div class="storno-reason-list" id="stornoGruende"></div>
                    </div>
                </div>

                <!-- Tab Content: Vergütung -->
                <div class="agentur-tab-content" id="tab-provision">
                    <div class="kpi-detail-grid">
                        <div class="kpi-detail-card highlight">
                            <div class="kpi-detail-header">Provisionsanspruch</div>
                            <div class="kpi-detail-value" id="provAnspruch">€0</div>
                            <div class="kpi-detail-sub">Verdiente Provision</div>
                        </div>
                        <div class="kpi-detail-card warning">
                            <div class="kpi-detail-header">Stornohaftung</div>
                            <div class="kpi-detail-value" id="provHaftung">€0</div>
                            <div class="kpi-detail-sub">Offene Haftungssumme</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Bonus-Erreichung</div>
                            <div class="kpi-detail-value" id="provBonus">0%</div>
                            <div class="kpi-detail-sub">Staffelziel-Fortschritt</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Deckungsbeitrag</div>
                            <div class="kpi-detail-value" id="provDeckung">€0</div>
                            <div class="kpi-detail-sub">YTD</div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Qualität -->
                <div class="agentur-tab-content" id="tab-qualitaet">
                    <div class="kpi-detail-grid">
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">NPS Score</div>
                            <div class="kpi-detail-value" id="qualNPS">0</div>
                            <div class="kpi-detail-sub">Net Promoter Score</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Beschwerdequote</div>
                            <div class="kpi-detail-value" id="qualBeschwerden">0</div>
                            <div class="kpi-detail-sub">Pro 1.000 Verträge</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">IDD-Compliance</div>
                            <div class="kpi-detail-value status-badge" id="qualIDD">-</div>
                            <div class="kpi-detail-sub">Regulatorische Vorgaben</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Schulungsstatus</div>
                            <div class="kpi-detail-value" id="qualSchulung">0/15h</div>
                            <div class="kpi-detail-sub">Weiterbildung (§34d GewO)</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Dokumentationsquote</div>
                            <div class="kpi-detail-value" id="qualDoku">0%</div>
                            <div class="kpi-detail-sub">Vollständige Protokolle</div>
                        </div>
                        <div class="kpi-detail-card">
                            <div class="kpi-detail-header">Underwriting-Quote</div>
                            <div class="kpi-detail-value" id="qualUnderwriting">0%</div>
                            <div class="kpi-detail-sub">Annahme-Quote</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         BILLING CHECK IFRAME PAGE
         ======================================== -->
    <div id="billingCheckPage" style="display: none;">
        <div class="billing-page">
            <div class="billing-header">
                <button class="back-button" onclick="closeBillingCheck()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg> Zurück</button>
                <h1 class="billing-page-title">Billing Check</h1>
            </div>
            <iframe
                id="billingCheckIframe"
                src="https://billingcheck.pages.dev/app"
                class="billing-iframe"
                allow="clipboard-read; clipboard-write"
            ></iframe>
        </div>
    </div>

    <!-- ========================================
         POTENTIALANALYSE PAGE
         ======================================== -->
    <div id="potentialAnalysePage" style="display: none;">
        <div class="potential-page">
            <div class="potential-header">
                <button class="back-button" onclick="closePotentialAnalyse()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg> Zurück</button>
                <h1 class="potential-page-title">Potentialanalyse</h1>
                <div class="potential-toggle-container">
                    <button class="potential-toggle-btn active" id="eigeneDatenBtn" onclick="showEigeneDaten()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        Eigene Daten
                    </button>
                    <button class="potential-toggle-btn fida-btn" id="fidaBtn" onclick="showFidaDaten()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 16v-4"></path>
                            <path d="M12 8h.01"></path>
                        </svg>
                        FIDA
                    </button>
                </div>
            </div>

            <!-- Filter Leiste -->
            <div class="potential-filters">
                <span class="filter-label">Filter:</span>
                <button class="potential-filter-btn active" data-filter="alle" onclick="filterPotentials('alle')">Alle</button>
                <button class="potential-filter-btn" data-filter="hausrat" onclick="filterPotentials('hausrat')">Hausrat</button>
                <button class="potential-filter-btn" data-filter="haftpflicht" onclick="filterPotentials('haftpflicht')">Haftpflicht</button>
                <button class="potential-filter-btn" data-filter="kfz" onclick="filterPotentials('kfz')">Kfz</button>
                <button class="potential-filter-btn" data-filter="leben" onclick="filterPotentials('leben')">Leben</button>
                <button class="potential-filter-btn" data-filter="bu" onclick="filterPotentials('bu')">BU</button>
                <button class="potential-filter-btn" data-filter="unfall" onclick="filterPotentials('unfall')">Unfall</button>
                <button class="potential-filter-btn" data-filter="sach" onclick="filterPotentials('sach')">Sach</button>
            </div>

            <div class="potential-content">
                <!-- Eigene Daten Tabelle -->
                <div class="potential-table-container" id="eigeneDatenContainer">
                    <div class="potential-info-box">
                        <h3>Cross-Selling Potentiale aus eigenen Bestandsdaten</h3>
                        <p>Identifizierte Potentiale basierend auf vorhandenen Verträgen und Kundenmerkmalen. Klicken Sie auf eine Zeile für Kundendetails.</p>
                    </div>
                    <table class="potential-table" id="eigeneDatenTable">
                        <thead>
                            <tr>
                                <th>Agentur</th>
                                <th>Vermittler-ID</th>
                                <th>Potential</th>
                                <th>Begründung</th>
                                <th>Priorität</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr onclick="openKundenDetail('Max Mustermann', 'VM00001')" class="clickable-row">
                                <td>Max Mustermann</td>
                                <td>VM00001</td>
                                <td><span class="potential-badge hausrat">Hausratversicherung</span></td>
                                <td>Hat bereits Wohngebäudeversicherung abgeschlossen</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Anna Schmidt', 'VM00002')" class="clickable-row">
                                <td>Anna Schmidt</td>
                                <td>VM00002</td>
                                <td><span class="potential-badge kfz">Kfz-Versicherung</span></td>
                                <td>Führerschein vorhanden, bisher keine Kfz-Versicherung</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr>
                                <td>Thomas Weber</td>
                                <td>VM00003</td>
                                <td><span class="potential-badge leben">Risikolebensversicherung</span></td>
                                <td>Familiengründung erkannt (Krankenversicherung für Kind)</td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr>
                                <td>Julia Fischer</td>
                                <td>VM00004</td>
                                <td><span class="potential-badge unfall">Unfallversicherung</span></td>
                                <td>Sportlicher Beruf, keine Unfallabsicherung</td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr>
                                <td>Michael Braun</td>
                                <td>VM00005</td>
                                <td><span class="potential-badge rechtsschutz">Rechtsschutzversicherung</span></td>
                                <td>Selbstständig, erhöhtes Rechtsrisiko</td>
                                <td><span class="priority low">Niedrig</span></td>
                            </tr>
                            <tr>
                                <td>Sandra Hoffmann</td>
                                <td>VM00006</td>
                                <td><span class="potential-badge hausrat">Hausratversicherung</span></td>
                                <td>Hochwertige Wohngebäudeversicherung ohne Hausrat</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr>
                                <td>Peter Schulz</td>
                                <td>VM00007</td>
                                <td><span class="potential-badge pflege">Pflegezusatzversicherung</span></td>
                                <td>Alter 55+, keine Pflegeabsicherung</td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Hans Müller', 'VM00020')" class="clickable-row">
                                <td>Hans Müller</td>
                                <td>VM00020</td>
                                <td><span class="potential-badge haftpflicht">Haftpflichtversicherung</span></td>
                                <td>Familienvater ohne Privathaftpflicht</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Sabine Krause', 'VM00021')" class="clickable-row">
                                <td>Sabine Krause</td>
                                <td>VM00021</td>
                                <td><span class="potential-badge bu">Berufsunfähigkeitsversicherung</span></td>
                                <td>Selbstständig, keine BU-Absicherung</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Frank Schneider', 'VM00022')" class="clickable-row">
                                <td>Frank Schneider</td>
                                <td>VM00022</td>
                                <td><span class="potential-badge kfz">Kfz-Versicherung</span></td>
                                <td>Neues Fahrzeug angemeldet, Versicherung läuft aus</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Monika Lehmann', 'VM00023')" class="clickable-row">
                                <td>Monika Lehmann</td>
                                <td>VM00023</td>
                                <td><span class="potential-badge leben">Risikolebensversicherung</span></td>
                                <td>Immobilienkauf erkannt, keine Absicherung</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Bernd Zimmermann', 'VM00024')" class="clickable-row">
                                <td>Bernd Zimmermann</td>
                                <td>VM00024</td>
                                <td><span class="potential-badge hausrat">Hausratversicherung</span></td>
                                <td>Umzug in neue Wohnung, kein Hausrat</td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Claudia Bergmann', 'VM00025')" class="clickable-row">
                                <td>Claudia Bergmann</td>
                                <td>VM00025</td>
                                <td><span class="potential-badge unfall">Unfallversicherung</span></td>
                                <td>Neues Hobby: Mountainbiking, keine Unfallversicherung</td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Stefan Vogel', 'VM00026')" class="clickable-row">
                                <td>Stefan Vogel</td>
                                <td>VM00026</td>
                                <td><span class="potential-badge haftpflicht">Haftpflichtversicherung</span></td>
                                <td>Student, keine eigene Haftpflicht</td>
                                <td><span class="priority low">Niedrig</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Petra Heinrich', 'VM00027')" class="clickable-row">
                                <td>Petra Heinrich</td>
                                <td>VM00027</td>
                                <td><span class="potential-badge pflege">Pflegezusatzversicherung</span></td>
                                <td>Pflegefall in der Familie, hohe Sensibilisierung</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Markus Kern', 'VM00028')" class="clickable-row">
                                <td>Markus Kern</td>
                                <td>VM00028</td>
                                <td><span class="potential-badge kfz">Kfz-Versicherung</span></td>
                                <td>Vertrag bei Wettbewerber läuft aus</td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Andrea Fuchs', 'VM00029')" class="clickable-row">
                                <td>Andrea Fuchs</td>
                                <td>VM00029</td>
                                <td><span class="potential-badge leben">Risikolebensversicherung</span></td>
                                <td>Junges Paar, Heirat geplant</td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Robert Lang', 'VM00030')" class="clickable-row">
                                <td>Robert Lang</td>
                                <td>VM00030</td>
                                <td><span class="potential-badge bu">Berufsunfähigkeitsversicherung</span></td>
                                <td>Handwerker ohne BU-Schutz</td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- FIDA Daten Tabelle -->
                <div class="potential-table-container" id="fidaContainer" style="display: none;">
                    <div class="potential-info-box fida">
                        <h3>FIDA - Externe Datenanreicherung (Financial Data Access)</h3>
                        <p>Potentiale basierend auf externen FIDA-Datenquellen: Versicherungsverträge bei Wettbewerbern, Kredit- und Hypothekendaten, Investmentdaten.</p>
                    </div>
                    <table class="potential-table fida-table" id="fidaTable">
                        <thead>
                            <tr>
                                <th>Kunde</th>
                                <th>Potential</th>
                                <th>Datenquelle</th>
                                <th>Begründung</th>
                                <th>Consent</th>
                                <th>Priorität</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr onclick="openKundenDetail('Max Mustermann', 'VM00001')" class="clickable-row">
                                <td>Max Mustermann</td>
                                <td><span class="potential-badge kfz">Kfz-Wechsel</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"></circle><path d="M16 8l-4 4-4-4"></path><path d="M12 16V12"></path></svg> Versicherung</span></td>
                                <td>Kfz bei Allianz läuft 31.12.2025 aus, SF-Klasse 12</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Klaus Meier', 'VM00010')" class="clickable-row">
                                <td>Klaus Meier</td>
                                <td><span class="potential-badge leben">Risikoleben</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg> Kredit</span></td>
                                <td>Hypothek €420.000 bei Sparkasse, keine Restschuldvers.</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Lisa Wagner', 'VM00011')" class="clickable-row">
                                <td>Lisa Wagner</td>
                                <td><span class="potential-badge altersvorsorge">Fondspolice</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> Investment</span></td>
                                <td>Depot €95.000, Sparrate €1.200/Mon., keine Altersvorsorge</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Frank Bauer', 'VM00012')" class="clickable-row">
                                <td>Frank Bauer</td>
                                <td><span class="potential-badge kfz">Kfz-Wechsel</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"></circle><path d="M16 8l-4 4-4-4"></path><path d="M12 16V12"></path></svg> Versicherung</span></td>
                                <td>Kfz bei HUK läuft 31.12.2025 aus, SF-Klasse 8, überteuert</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Maria Klein', 'VM00013')" class="clickable-row">
                                <td>Maria Klein</td>
                                <td><span class="potential-badge wohngebaeude">Wohngebäude</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg> Kredit</span></td>
                                <td>Neue Baufinanzierung €280.000 abgeschlossen</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Stefan Richter', 'VM00014')" class="clickable-row">
                                <td>Stefan Richter</td>
                                <td><span class="potential-badge bu">BU-Upgrade</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg> Bank</span></td>
                                <td>Gehaltserhöhung +22% erkannt, BU-Lücke €1.800/Mon.</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Christine Wolf', 'VM00015')" class="clickable-row">
                                <td>Christine Wolf</td>
                                <td><span class="potential-badge sach">Sachvers. Wechsel</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"></circle><path d="M16 8l-4 4-4-4"></path><path d="M12 16V12"></path></svg> Versicherung</span></td>
                                <td>Hausrat bei ERGO €380/J. - Marktvergl. €210/J. möglich</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Uwe Schmitz', 'VM00040')" class="clickable-row">
                                <td>Uwe Schmitz</td>
                                <td><span class="potential-badge leben">Kapital-LV</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> Investment</span></td>
                                <td>ETF-Sparplan €500/Mon., keine Kapitalabsicherung</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Heike Maier', 'VM00041')" class="clickable-row">
                                <td>Heike Maier</td>
                                <td><span class="potential-badge altersvorsorge">Riester-Optimierung</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Altersvorsorge</span></td>
                                <td>Riester bei Union Invest, Kosten 2,1% - Wechsel lohnend</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Jürgen Böhm', 'VM00042')" class="clickable-row">
                                <td>Jürgen Böhm</td>
                                <td><span class="potential-badge leben">Risikoleben</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg> Kredit</span></td>
                                <td>Kreditrate €1.500/Mon. endet 2027, Restschuld €85.000</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Gisela Haas', 'VM00043')" class="clickable-row">
                                <td>Gisela Haas</td>
                                <td><span class="potential-badge haftpflicht">Betriebshaftpflicht</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg> Bank</span></td>
                                <td>Geschäftskonto eröffnet - Firmengründung erkannt</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Torsten Keller', 'VM00044')" class="clickable-row">
                                <td>Torsten Keller</td>
                                <td><span class="potential-badge kfz">Kfz-Premium</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"></circle><path d="M16 8l-4 4-4-4"></path><path d="M12 16V12"></path></svg> Versicherung</span></td>
                                <td>SF-Klasse 15 bei Wettbewerber, Premium-Tarif möglich</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Birgit Sommer', 'VM00045')" class="clickable-row">
                                <td>Birgit Sommer</td>
                                <td><span class="potential-badge pflege">Pflegezusatz</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg> Bank</span></td>
                                <td>Regelmäßige Überweisungen an Pflegedienst erkannt</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority high">Hoch</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Wolfgang Stein', 'VM00046')" class="clickable-row">
                                <td>Wolfgang Stein</td>
                                <td><span class="potential-badge unfall">Unfallversicherung</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"></circle><path d="M16 8l-4 4-4-4"></path><path d="M12 16V12"></path></svg> Versicherung</span></td>
                                <td>Kein Unfallschutz bei Wettbewerbern erkennbar</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                            <tr onclick="openKundenDetail('Ingrid Baumann', 'VM00047')" class="clickable-row">
                                <td>Ingrid Baumann</td>
                                <td><span class="potential-badge altersvorsorge">bAV-Optimierung</span></td>
                                <td><span class="fida-source-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Altersvorsorge</span></td>
                                <td>bAV bei altem Arbeitgeber, Portierung prüfen</td>
                                <td><span class="consent yes">Aktiv</span></td>
                                <td><span class="priority medium">Mittel</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         KUNDENDETAIL PAGE
         ======================================== -->
    <div id="kundenDetailPage" style="display: none;">
        <div class="kunden-page">
            <div class="kunden-header">
                <button class="back-button" onclick="closeKundenDetail()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Zurück
                </button>
                <h1 class="kunden-page-title">Kundendetails</h1>
            </div>

            <!-- Tab Navigation -->
            <div class="kunden-tabs">
                <button class="kunden-tab active" data-tab="stammdaten" onclick="switchKundenTab('stammdaten')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Stammdaten
                </button>
                <button class="kunden-tab" data-tab="vertraege" onclick="switchKundenTab('vertraege')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    Verträge
                </button>
                <button class="kunden-tab fida-tab" data-tab="fida" onclick="switchKundenTab('fida')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"></path>
                    </svg>
                    FIDA
                </button>
            </div>

            <div class="kunden-content">
                <!-- TAB: Stammdaten -->
                <div id="tabStammdaten" class="kunden-tab-content active">
                    <!-- Stammdaten Karte -->
                    <div class="kunden-card stammdaten-card">
                        <div class="kunden-card-header">
                            <h2>Stammdaten</h2>
                        </div>
                        <div class="kunden-stammdaten">
                            <div class="kunden-foto-container">
                                <div class="kunden-foto" onclick="triggerProfileUpload('kunde')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </div>
                                <h3 id="kundenName">Max Mustermann</h3>
                                <span class="kunden-id" id="kundenVermittlerId">VM00001</span>
                            </div>
                            <div class="kunden-info-grid">
                                <div class="info-item">
                                    <span class="info-label">Geburtsdatum</span>
                                    <span class="info-value" id="kundenGeburtsdatum">15.03.1985</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Adresse</span>
                                    <span class="info-value" id="kundenAdresse">Musterstraße 123, 12345 Musterstadt</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Telefon</span>
                                    <span class="info-value" id="kundenTelefon">+49 123 456789</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">E-Mail</span>
                                    <span class="info-value" id="kundenEmail">max.mustermann@email.de</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Beruf</span>
                                    <span class="info-value" id="kundenBeruf">Angestellter</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Familienstand</span>
                                    <span class="info-value" id="kundenFamilienstand">Verheiratet</span>
                                </div>
                                <div class="info-item full-width">
                                    <span class="info-label">Kinder</span>
                                    <div class="info-value" id="kundenKinder">
                                        <span class="kinder-badge">Lena (8 Jahre)</span>
                                        <span class="kinder-badge">Paul (5 Jahre)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vertriebsimpuls Box -->
                    <div class="kunden-card vertriebsimpuls-card">
                        <div class="kunden-card-header vertriebsimpuls">
                            <h2>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                </svg>
                                Vertriebsimpuls
                            </h2>
                        </div>
                        <div class="vertriebsimpuls-content">
                            <div class="impuls-item highlight">
                                <div class="impuls-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                </div>
                                <div class="impuls-text">
                                    <strong>Berufsunfähigkeitsversicherung (BU) anbieten</strong>
                                    <p>Weder in den internen Bestandsdaten noch in den externen FIDA-Daten liegt eine BU-Absicherung vor. Bei einem Angestellten mit Familie besteht hier ein erhöhter Absicherungsbedarf.</p>
                                </div>
                                <span class="impuls-priority high">Hohe Priorität</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Verträge -->
                <div id="tabVertraege" class="kunden-tab-content">
                    <!-- Eigene Verträge -->
                    <div class="kunden-card">
                        <div class="kunden-card-header">
                            <h2>Eigene Verträge</h2>
                        </div>
                        <table class="kunden-table">
                            <thead>
                                <tr>
                                    <th>Versicherungstyp</th>
                                    <th>Jahresprämie</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="kundenVertraege">
                                <tr>
                                    <td>Wohngebäudeversicherung</td>
                                    <td>€450/Jahr</td>
                                    <td><span class="status-badge aktiv">Aktiv</span></td>
                                </tr>
                                <tr>
                                    <td>Kfz-Versicherung</td>
                                    <td>€680/Jahr</td>
                                    <td><span class="status-badge aktiv">Aktiv</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Externe Verträge (FIDA) -->
                    <div class="kunden-card fida-card">
                        <div class="kunden-card-header fida">
                            <h2>Externe Finanzbeziehungen (FIDA)</h2>
                        </div>
                        <table class="kunden-table fida-table">
                            <thead>
                                <tr>
                                    <th>Finanzinstitut</th>
                                    <th>Produktart</th>
                                    <th>Hinweis</th>
                                </tr>
                            </thead>
                            <tbody id="kundenFidaVertraege">
                                <tr>
                                    <td>Sparkasse</td>
                                    <td>Girokonto</td>
                                    <td>Hauptkonto</td>
                                </tr>
                                <tr>
                                    <td>DWS</td>
                                    <td>Depot</td>
                                    <td>Fondssparen</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: FIDA -->
                <div id="tabFida" class="kunden-tab-content">
                    <!-- FIDA Status Card -->
                    <div class="kunden-card fida-status-card">
                        <div class="kunden-card-header fida">
                            <h2>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                FIDA Consent-Status
                            </h2>
                        </div>
                        <div class="fida-status-content">
                            <div class="fida-status-grid">
                                <div class="fida-status-item">
                                    <span class="fida-status-label">Status</span>
                                    <span class="fida-status-value consent-active" id="fidaConsentStatus">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        Aktiv
                                    </span>
                                </div>
                                <div class="fida-status-item">
                                    <span class="fida-status-label">Erteilt am</span>
                                    <span class="fida-status-value" id="fidaConsentDate">15.03.2024</span>
                                </div>
                                <div class="fida-status-item">
                                    <span class="fida-status-label">Gültig bis</span>
                                    <span class="fida-status-value" id="fidaConsentExpiry">15.03.2026</span>
                                </div>
                                <div class="fida-status-item">
                                    <span class="fida-status-label">Datenquellen</span>
                                    <span class="fida-status-value" id="fidaDataSources">4 aktiv</span>
                                </div>
                            </div>
                            <div class="fida-datasources">
                                <div class="fida-datasource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                    Bankdaten
                                </div>
                                <div class="fida-datasource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                        <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path>
                                    </svg>
                                    Kreditdaten
                                </div>
                                <div class="fida-datasource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                    </svg>
                                    Investmentdaten
                                </div>
                                <div class="fida-datasource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M16 8l-4 4-4-4"></path>
                                        <path d="M12 16V12"></path>
                                    </svg>
                                    Versicherungsdaten
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FIDA Potentiale -->
                    <div class="kunden-card">
                        <div class="kunden-card-header fida">
                            <h2>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                </svg>
                                FIDA-Potentiale
                            </h2>
                        </div>
                        <table class="kunden-table fida-table">
                            <thead>
                                <tr>
                                    <th>Potential</th>
                                    <th>Datenquelle</th>
                                    <th>Begründung</th>
                                    <th>Status</th>
                                    <th>Priorität</th>
                                </tr>
                            </thead>
                            <tbody id="kundenFidaPotentiale">
                                <tr>
                                    <td><span class="potential-badge kfz">Kfz-Versicherung</span></td>
                                    <td>
                                        <span class="fida-source-badge">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <path d="M16 8l-4 4-4-4"></path>
                                                <path d="M12 16V12"></path>
                                            </svg>
                                            Versicherung
                                        </span>
                                    </td>
                                    <td>Kfz-Vertrag bei Allianz läuft am 31.12.2025 aus, SF-Klasse 12</td>
                                    <td><span class="potential-status angeschrieben">Angeschrieben</span></td>
                                    <td><span class="priority high">Hoch</span></td>
                                </tr>
                                <tr>
                                    <td><span class="potential-badge leben">Risikolebensversicherung</span></td>
                                    <td>
                                        <span class="fida-source-badge">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path>
                                            </svg>
                                            Kredit
                                        </span>
                                    </td>
                                    <td>Hypothek €320.000 bei Sparkasse, keine Restschuldversicherung</td>
                                    <td><span class="potential-status offen">Offen</span></td>
                                    <td><span class="priority high">Hoch</span></td>
                                </tr>
                                <tr>
                                    <td><span class="potential-badge altersvorsorge">Private Altersvorsorge</span></td>
                                    <td>
                                        <span class="fida-source-badge">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                            </svg>
                                            Investment
                                        </span>
                                    </td>
                                    <td>Depot €85.000, hohe Sparrate €800/Monat, keine Altersvorsorge</td>
                                    <td><span class="potential-status termin">Termin 12.12.</span></td>
                                    <td><span class="priority high">Hoch</span></td>
                                </tr>
                                <tr>
                                    <td><span class="potential-badge bu">Berufsunfähigkeitsversicherung</span></td>
                                    <td>
                                        <span class="fida-source-badge">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                                <line x1="1" y1="10" x2="23" y2="10"></line>
                                            </svg>
                                            Bank
                                        </span>
                                    </td>
                                    <td>Gehaltserhöhung um 18% erkannt, BU-Lücke vergrößert</td>
                                    <td><span class="potential-status offen">Offen</span></td>
                                    <td><span class="priority medium">Mittel</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Kommunikationshistorie -->
                    <div class="kunden-card">
                        <div class="kunden-card-header">
                            <h2>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"></path>
                                </svg>
                                Kommunikationshistorie
                            </h2>
                        </div>
                        <div class="kommunikation-timeline" id="kundenKommunikation">
                            <div class="komm-item auto">
                                <div class="komm-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                        <polyline points="22,6 12,13 2,6"></polyline>
                                    </svg>
                                </div>
                                <div class="komm-content">
                                    <div class="komm-header">
                                        <span class="komm-type">Automatische E-Mail</span>
                                        <span class="komm-date">28.11.2025, 09:15</span>
                                    </div>
                                    <div class="komm-subject">Kfz-Versicherung: Ihr Vertrag läuft aus</div>
                                    <div class="komm-preview">Sehr geehrter Herr Mustermann, Ihr Kfz-Vertrag bei der Allianz läuft am 31.12.2025 aus. Wir haben ein attraktives Angebot für Sie...</div>
                                    <div class="komm-status">
                                        <span class="komm-status-badge geoeffnet">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                <circle cx="12" cy="12" r="3"></circle>
                                            </svg>
                                            Geöffnet am 28.11.2025, 14:32
                                        </span>
                                    </div>
                                </div>
                                <button class="komm-action" onclick="viewKommunikation('email-1')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    Ansehen
                                </button>
                            </div>

                            <div class="komm-item auto">
                                <div class="komm-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <div class="komm-content">
                                    <div class="komm-header">
                                        <span class="komm-type">Automatischer Brief</span>
                                        <span class="komm-date">15.11.2025</span>
                                    </div>
                                    <div class="komm-subject">FIDA-Datenfreigabe: Neue Potentiale erkannt</div>
                                    <div class="komm-preview">Basierend auf Ihren freigegebenen Finanzdaten haben wir Optimierungsmöglichkeiten für Ihre Versicherungssituation identifiziert...</div>
                                    <div class="komm-status">
                                        <span class="komm-status-badge versendet">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                            Versendet
                                        </span>
                                    </div>
                                </div>
                                <button class="komm-action" onclick="viewKommunikation('brief-1')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    Ansehen
                                </button>
                            </div>

                            <div class="komm-item manuell">
                                <div class="komm-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"></path>
                                    </svg>
                                </div>
                                <div class="komm-content">
                                    <div class="komm-header">
                                        <span class="komm-type">Telefonat</span>
                                        <span class="komm-date">10.11.2025, 11:20</span>
                                    </div>
                                    <div class="komm-subject">Rückruf wegen Altersvorsorge-Angebot</div>
                                    <div class="komm-preview">Kunde interessiert an fondsgebundener Rentenversicherung. Termin für 12.12. vereinbart.</div>
                                    <div class="komm-status">
                                        <span class="komm-status-badge termin">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                            Termin: 12.12.2025
                                        </span>
                                    </div>
                                </div>
                                <button class="komm-action" onclick="viewKommunikation('call-1')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    Details
                                </button>
                            </div>

                            <div class="komm-item auto">
                                <div class="komm-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                        <polyline points="22,6 12,13 2,6"></polyline>
                                    </svg>
                                </div>
                                <div class="komm-content">
                                    <div class="komm-header">
                                        <span class="komm-type">Automatische E-Mail</span>
                                        <span class="komm-date">01.10.2025, 08:00</span>
                                    </div>
                                    <div class="komm-subject">Willkommen bei FIDA - Ihre Daten sind jetzt verknüpft</div>
                                    <div class="komm-preview">Vielen Dank für Ihre FIDA-Datenfreigabe. Ab sofort können wir Ihnen personalisierte Versicherungsempfehlungen basierend auf Ihrer Finanzsituation anbieten...</div>
                                    <div class="komm-status">
                                        <span class="komm-status-badge geoeffnet">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                <circle cx="12" cy="12" r="3"></circle>
                                            </svg>
                                            Geöffnet am 01.10.2025, 19:45
                                        </span>
                                    </div>
                                </div>
                                <button class="komm-action" onclick="viewKommunikation('email-2')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    Ansehen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MAIN APPLICATION (v02 Dashboard)
         ======================================== -->
    <div id="mainApp" style="display: none;">
    <!-- Upload Section -->
    <div class="upload-section">
        <label class="upload-label" for="csvUpload">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            CSV-Datei hochladen
            <input type="file" id="csvUpload" accept=".csv">
        </label>
        <span id="fileStatus" style="margin-left: 1rem; color: #0369a1; font-weight: 600;"></span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="back-button" onclick="backToLanding()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Zurück
                </button>
                <div class="view-mode-toggle">
                    <button class="active" data-mode="dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        Dashboard
                    </button>
                    <button data-mode="table">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                        Tabelle
                    </button>
                </div>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Jahr:</span>
                    <select id="yearFilter">
                        <option value="2025">2025 YTD</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <!-- NEU: Agentur Filter -->
                <div class="filter-group">
                    <span class="filter-label">Agentur:</span>
                    <div class="dropdown">
                        <button class="dropdown-button" id="agenturFilterButton">
                            <span>Alle Agenturen</span>
                            <span>▼</span>
                        </button>
                        <div class="dropdown-menu" id="agenturFilterMenu">
                            <div class="dropdown-item" data-value="alle">
                                <span>Alle Agenturen</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Ende Agentur Filter -->
                <div class="filter-group">
                    <span class="filter-label">Vertriebssilo:</span>
                    <select id="siloFilter">
                        <option value="alle">Alle Vermittler</option>
                        <option value="Ausschließlichkeit">Ausschließlichkeit</option>
                        <option value="Makler">Makler</option>
                        <option value="Direktvertrieb">Direktvertrieb</option>
                        <option value="Banken">Banken</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Segment:</span>
                    <div class="dropdown">
                        <button class="dropdown-button" id="segmentButton">
                            <span>Alle Segmente</span>
                            <span>▼</span>
                        </button>
                        <div class="dropdown-menu" id="segmentMenu">
                            <div class="dropdown-item" data-value="alle">
                                <div class="checkbox checked"></div>
                                <span>Alle Segmente</span>
                            </div>
                            <div class="dropdown-separator"></div>
                            <div class="dropdown-item" data-value="Leben">
                                <div class="checkbox"></div>
                                <span>Leben</span>
                            </div>
                            <div class="dropdown-item" data-value="Kranken">
                                <div class="checkbox"></div>
                                <span>Kranken</span>
                            </div>
                            <div class="dropdown-item" data-value="Schaden">
                                <div class="checkbox"></div>
                                <span>Schaden</span>
                            </div>
                            <div class="dropdown-item" data-value="Kfz">
                                <div class="checkbox"></div>
                                <span>Kfz</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group" id="productFilterGroup" style="display: none;">
                    <span class="filter-label">Produkt:</span>
                    <div class="dropdown">
                        <button class="dropdown-button" id="productButton">
                            <span>Alle Produkte</span>
                            <span>▼</span>
                        </button>
                        <div class="dropdown-menu" id="productMenu"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard View -->
    <main class="main" id="dashboardView">
        <div class="kpi-grid" id="kpiGrid"></div>
        <div class="map-sidebar">
            <div id="map" class="map-container"></div>
            <div class="map-info">
                <h3>Ausgewählte Landkreise</h3>
                <div class="selected-states" id="selectedStates">
                    <span class="empty-state">— keine —</span>
                </div>
                <button class="clear-button" id="clearStates" disabled>Alle abwählen</button>
            </div>

            <!-- ✨ v14: KI-Antwort Display unter der Karte -->
            <div class="ai-response-panel" id="aiResponsePanel" style="display: none;">
                <div class="ai-response-header">
                    <h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="vertical-align: middle; margin-right: 6px;"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>KI-Analyse</h3>
                    <button class="ai-response-close" id="aiResponseClose">✕</button>
                </div>
                <div class="ai-response-content" id="aiResponseContent">
                    <!-- KI-Antworten werden hier formatiert angezeigt -->
                </div>
            </div>
        </div>
    </main>

    <!-- Table View -->
    <div class="table-view-container" id="tableView">
        <div style="max-width: 1920px; margin: 0 auto; padding: 1.25rem;">
            <div class="table-controls">
                <div class="table-view-toggle">
                    <button class="active" data-table-view="bundeslaender">🗺️ Bundesländer</button>
                    <button data-table-view="landkreise">🏘️ Landkreise</button>
                    <button data-table-view="agentur">👤 Agenturen</button>
                </div>
                <!-- NEU: Agentur-Mehrfachauswahl Panel -->
                <div class="filter-group" id="agenturMultiSelector" style="display: none;">
                    <button class="filter-button" id="agenturMultiButton">
                        <span>Agenturen auswählen</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="dropdown-menu agentur-dropdown" id="agenturMultiMenu" style="max-height: 400px; overflow-y: auto;">
                        <div class="dropdown-item" data-value="alle">
                            <span class="checkbox"></span>
                            <span>Alle Agenturen</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div id="agenturCheckboxList">
                            <!-- Wird dynamisch gefüllt -->
                        </div>
                    </div>
                </div>
                <div class="selected-agenturen" id="selectedAgenturen" style="display: none;"></div>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div class="fullscreen-modal" id="fullscreenModal">
        <div class="fullscreen-kpi">
            <div class="fullscreen-header">
                <h2 class="fullscreen-title" id="fullscreenTitle">KPI Title</h2>
                <button class="fullscreen-close" onclick="closeFullscreen()">✕ Schließen</button>
            </div>
            <div class="fullscreen-chart">
                <canvas id="fullscreenChart"></canvas>
            </div>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div class="chat-widget" id="chatWidget" style="display: none;">
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-icon-deloitte">
                    <span class="deloitte-d">D</span>
                </div>
                <div>
                    <div class="chat-title">Sales Steering - Agent</div>
                    <div class="chat-subtitle">KI-gestützte Datenanalyse</div>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-minimize" id="chatMinimize">−</button>
                <button class="chat-close" id="chatClose">✕</button>
            </div>
        </div>
        
        <div class="chat-body" id="chatBody">
            <div class="chat-welcome">
                <div class="welcome-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                <h3>Willkommen!</h3>
                <p>Ich kann dir bei der Analyse deiner Dashboard-Daten helfen.</p>

                <!-- ✨ v14: Probefragen als anklickbare Buttons -->
                <div class="sample-questions">
                    <button class="sample-question-btn" onclick="askSampleQuestion('Zeige mir die Top 5 Vermittler nach Neugeschäft')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        Top 5 Vermittler nach Neugeschäft
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Welches Bundesland hat die beste Performance?')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>
                        Beste Performance nach Bundesland
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Filtere nach Max Mustermann')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        Nach Max Mustermann filtern
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Wie entwickelt sich der NPS Score?')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                        NPS Score Entwicklung
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Vergleiche Makler vs. Ausschließlichkeit')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        Makler vs. Ausschließlichkeit
                    </button>
                    <button class="sample-question-btn" onclick="askSampleQuestion('Zeige mir die Stornoquoten nach Segment')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        Stornoquoten nach Segment
                    </button>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="Stelle eine Frage zu deinen Daten..."
                rows="1"
            ></textarea>
            <button class="chat-send" id="chatSend">
                <span>▶</span>
            </button>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button class="chat-toggle" id="chatToggle" style="display: none;">
        <span class="chat-badge" id="chatBadge">1</span>
        <span>💬</span>
    </button>

    <!-- Info Tooltip -->
    <div id="info-tooltip" style="
        position: absolute;
        display: none;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        pointer-events: none;
        z-index: 1000;
        font-size: 13px;
        border: 1px solid #e2e8f0;
    "></div>
    </div>

    <!-- Version Display - Always visible on all pages -->
    <div class="version-display">v19</div>

    <!-- JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/data.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/tables.js"></script>
    <script src="js/map-counties.js"></script>
    <script src="js/main.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/agentur-overview.js"></script>
    <script src="js/landing.js"></script>
</body>
</html>